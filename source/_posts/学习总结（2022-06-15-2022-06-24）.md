---
title: å­¦ä¹ æ€»ç»“ï¼ˆ2022.06.15-2022.06.24ï¼‰
date: 2022-07-04 19:30:04
categories:
- æŠ€æœ¯
tags:
- JavaEE
- Spring
---

## åŠ¨æ€ä»£ç†

### JDKåŠ¨æ€ä»£ç†

JDKåŠ¨æ€ä»£ç†æ˜¯åŸºäºJavaçš„åå°„æœºåˆ¶å®ç°çš„ï¼Œä½¿ç”¨jdkä¸­çš„æ¥å£å’Œç±»å®ç°ä»£ç†å¯¹è±¡çš„åŠ¨æ€åˆ›å»ºï¼Œä½†æ˜¯è¦æ±‚ä»£ç†å¯¹è±¡å¿…é¡»å®ç°æ¥å£ã€‚

JDKåŠ¨æ€ä»£ç†çš„å®ç°æ­¥éª¤å¦‚ä¸‹ã€‚

1. æ–°å»ºä¸€ä¸ªæ¥å£ï¼Œä½œä¸ºç›®æ ‡æ¥å£ã€‚

```java
public interface UserService {

    public void sayHello();
}
```

2. ä¸ºæ¥å£åˆ›å»ºå®ç°ç±»ã€‚

```java
public class UserServiceImpl implements UserService{

    @Override
    public void sayHello() {
        System.out.println("hello spring");
    }
    
}
```

3. åˆ›å»ºä¸€ä¸ªç±»å®ç°InvocationHandleræ¥å£åŠå…¶invokeæ–¹æ³•ï¼Œåœ¨`method.invoke()`å‰åæ‰§è¡Œå¯¹æ–¹æ³•çš„å¢å¼ºã€‚

```java
public class CustomInvocationHandler implements InvocationHandler {
    @Override
    public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {
        return null;
    }
}
```

4. åœ¨mainæ–¹æ³•ä¸­è°ƒç”¨`Proxy.newProxyInstance()`åˆ›å»ºJDKåŠ¨æ€ä»£ç†ï¼Œä½¿ç”¨ä»£ç†å¯¹è±¡æ‰§è¡Œæ–¹æ³•ã€‚

```java
	@Test
	public void mytest4() {
        UserService instance = new UserServiceImpl(); // instance ğŸ‘‰ method.invoke(instance,args);
        // UserServiceImpl ğŸ‘‰ sayHello
        // Proxy ğŸ‘‰ sayHello
        UserService userServiceProxy = (UserService) Proxy.newProxyInstance(UserServiceImpl.class.getClassLoader(),
                UserServiceImpl.class.getInterfaces(),
                new InvocationHandler() {
                    @Override
                    public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {
                        //jdsfkhjasdjyr
                        System.out.println("jdsfkhjasdjyr");
                        Object invoke = method.invoke(instance, args);
                        //dfjkasdhjfisdya
                        System.out.println("dfjkasdhjfisdya");
                        return invoke;
                    }
                });
        userServiceProxy.sayHello();//invocationHandler.invoke
    }
```

### CglibåŠ¨æ€ä»£ç†

CglibåŠ¨æ€ä»£ç†åªé’ˆå¯¹ç±»å®ç°ä»£ç†ï¼Œä¸éœ€è¦å®ç°æ¥å£ã€‚

CglibåŠ¨æ€ä»£ç†çš„å®ç°æ­¥éª¤å¦‚ä¸‹ã€‚

1. åˆ›å»ºä¸€ä¸ªç±»å®ç°MethodInterceptoræ¥å£åŠå…¶`intercept`æ–¹æ³•ã€‚

```java
public class MyMethodInterceptor implements MethodInterceptor {
    /**
     * cglib
     *
     * @param o cglibç”Ÿæˆçš„ä»£ç†å¯¹è±¡
     * @param method è¢«ä»£ç†å¯¹è±¡çš„æ–¹æ³•
     * @param objects æ–¹æ³•å…¥å‚
     * @param methodProxy ä»£ç†æ–¹æ³•
     * @return
     * @throws Throwable
     */
    @Override
    public Object intercept(Object o, Method method, Object[] objects, MethodProxy methodProxy) throws Throwable {
        System.out.println("before advice...");
        Object object = methodProxy.invokeSuper(o, objects);
        System.out.println("after advice...");
        return object;
    }
}
```

2. åœ¨mainæ–¹æ³•ä¸­ï¼Œé€šè¿‡Enhancerè·å–ä»£ç†å¯¹è±¡ã€‚

```java
public class Main {
    public static void main(String[] args) {
        //é€šè¿‡CGLIBåŠ¨æ€ä»£ç†è·å–ä»£ç†å¯¹è±¡çš„è¿‡ç¨‹
        Enhancer enhancer = new Enhancer();
        //è®¾ç½®enhancerå¯¹è±¡çš„çˆ¶ç±»
        enhancer.setSuperclass(HelloService.class);
        //è®¾ç½®enhancerçš„å›è°ƒå¯¹è±¡
        enhancer.setCallback(new MyMethodInterceptor());
        //åˆ›å»ºä»£ç†å¯¹è±¡
        HelloService proxy = (HelloService) enhancer.create();
        //é€šè¿‡ä»£ç†å¯¹è±¡è°ƒç”¨ç›®æ ‡æ–¹æ³•
        proxy.sayHello();
    }
}
```

## IOC/DI

IOCï¼Œæ§åˆ¶åè½¬ï¼Œå°†ç”Ÿæˆå®ä¾‹çš„æ§åˆ¶æƒäº¤ç”±Springå®¹å™¨ï¼Œå®¹å™¨åªæ§åˆ¶å®ä¾‹çš„ç”Ÿæˆï¼Œè€Œå¼€å‘äººå‘˜åªéœ€è¦å¾€å®¹å™¨ä¸­æ³¨å†Œéœ€è¦ç”Ÿæˆå®ä¾‹çš„ç±»ï¼Œå³ç»„ä»¶ï¼Œå¹¶åœ¨éœ€è¦æ—¶å–å‡ºè¯¥ç»„ä»¶çš„å¯¹è±¡å³å¯ã€‚

DIï¼Œä¾èµ–æ³¨å…¥ï¼Œå³å…·ä½“çš„IOCå®ç°æ–¹å¼ã€‚ä¸€èˆ¬é€šè¿‡é…ç½®æ–‡ä»¶å’Œæ³¨è§£æ¥å®Œæˆä¾èµ–æ³¨å…¥ã€‚

### XML

åœ¨Springçš„XMLæ–‡ä»¶ä¸­æ³¨å†Œç»„ä»¶ã€‚

```xml
<!--æ³¨å†Œç»„ä»¶ â†’ æä¾›ä¿¡æ¯ â†’ å‘å®¹å™¨ä¸­æ”¾å…¥å®ä¾‹-->
<!--idå±æ€§ï¼šç»„ä»¶åœ¨å®¹å™¨ä¸­çš„å”¯ä¸€æ ‡è¯† â†’ å¯ä»¥çœç•¥-->
<!--classå±æ€§ï¼šç»„ä»¶çš„å…¨é™å®šç±»å-->
<bean id="userDao" class="com.cskaoyan.dao.UserDaoImpl"/>

<!--setæ–¹æ³•æ¥ç»´æŠ¤ç»„ä»¶ä¹‹é—´çš„å…³ç³»-->
<bean id="userService" class="com.cskaoyan.service.UserServiceImpl">
    <!--propertyæ ‡ç­¾çš„nameå±æ€§ â†’ setæ–¹æ³•-->
    <!--refå±æ€§ï¼šreference â†’ å®¹å™¨ä¸­çš„ç»„ä»¶id-->
    <property name="userDao" ref="userDao"/>
</bean>

<bean id="orderService" class="com.cskaoyan.service.OrderServiceImpl">
    <property name="userDao" ref="userDao"/>
</bean>
```

å–å‡ºç»„ä»¶ã€‚

```java
@Test
public void mytest1() {
    // åˆå§‹åŒ–Springå®¹å™¨
    ApplicationContext applicationContext = new ClassPathXmlApplicationContext("application.xml");

    // é€šè¿‡idå–å‡ºç»„ä»¶
    UserDao userDao = (UserDao) applicationContext.getBean("userDao");
    // é€šè¿‡ç±»å‹å–å‡ºç»„ä»¶byType â†’ class å¯ä»¥å†™æ¥å£ã€å®ç°ç±» â†’ è¯¥ç±»å‹çš„ç»„ä»¶åœ¨å®¹å™¨ä¸­åªæœ‰ä¸€ä¸ª
    // å»ºè®®ç”¨æ¥å£
    UserService userService1 = applicationContext.getBean(UserService.class);
    UserService userService2 = applicationContext.getBean(UserServiceImpl.class);

    // é€šè¿‡idå’Œç±»å‹å…±åŒå–å‡º
    OrderService orderService = applicationContext.getBean("orderService", OrderService.class);
}
```

### æ³¨è§£

ä¹Ÿå¯ä»¥ä½¿ç”¨æ³¨è§£æ³¨å†Œç»„ä»¶ã€‚å¯ä»¥åœ¨æ³¨è§£ä¸­æŒ‡å®šç»„ä»¶idï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨é»˜è®¤çš„ç»„ä»¶idï¼Œé»˜è®¤idä¸€èˆ¬ä¸ºç±»åçš„é¦–å­—æ¯å°å†™ã€‚

```java
// é€šç”¨æ³¨è§£
@Component

// serviceå±‚
@Service

// daoå±‚
@Repository

// controllerå±‚
@Controller
```

### é…ç½®ç±»

åœ¨ä¸€ä¸ªç±»ä¸ŠåŠ ä¸Š@Configurationæ³¨è§£ï¼Œè¡¨ç¤ºè¯¥ç±»è¢«æ³¨å†Œä¸ºä¸€ä¸ªç»„ä»¶ï¼Œä¸”è¯¥ç±»ä¸ºä¸€ä¸ªé…ç½®ç±»ã€‚ç±»ä¸­çš„æ–¹æ³•å¯ä»¥è¢«@Beanæ³¨è§£ä¿®é¥°ï¼Œè¡¨ç¤ºè¯¥æ–¹æ³•çš„è¿”å›å€¼çš„å®ä¾‹ä¼šè¢«æ³¨å†Œä¸ºä¸€ä¸ªç»„ä»¶ã€‚

```java
@Configuration
// @ComponentScanæ³¨è§£è¡¨ç¤ºæ‰«ææŒ‡å®šåŒ…ä¸‹çš„æ‰€æœ‰ç±»ï¼Œå¹¶å°†å¸¦æœ‰@Componentç­‰ç›¸å…³æ³¨è§£çš„ç±»æ³¨å†Œä¸ºç»„ä»¶
@ComponentScan("com.cskaoyan")
public class SpringConfiguration {

    /**
     * è¿”å›å€¼ç±»å‹ï¼šSpringå®¹å™¨ä¸­çš„ç»„ä»¶ç±»å‹
     * è¿”å›å€¼ï¼šè¿”å›å€¼æ³¨å†Œä¸ºå®¹å™¨ä¸­çš„ç»„ä»¶
     * ç»„ä»¶IDï¼šé»˜è®¤å€¼æ˜¯æ–¹æ³•åï¼›å¦‚æœæƒ³è¦æŒ‡å®šç»„ä»¶idï¼Œå¯ä»¥ä½¿ç”¨@Beançš„valueå±æ€§
     */
    @Bean("druidDatasource")
    public DataSource dataSource() {
        DruidDataSource dataSource = new DruidDataSource();
        dataSource.setDriverClassName("com.mysql.jdbc.Driver");
        dataSource.setUrl("jdbc:mysql://localhost:3306/cskaoyan_db");
        dataSource.setUsername("root");
        dataSource.setPassword("123456");

        return dataSource;
    }
    /**
     * å½¢å‚ï¼šé»˜è®¤æŒ‰ç…§ç±»å‹ä»å®¹å™¨ä¸­å–å‡ºç»„ä»¶;æƒ³è¦æŒ‡å®šç»„ä»¶id â†’ @Qualifier
     */
    // æ³¨å†Œä¸€ä¸ªUserServiceImplç»„ä»¶
    @Bean
    public UserService userService(@Qualifier("userDaoImpl") UserDao userDao) {
        UserServiceImpl userService = new UserServiceImpl();
        // ä»å®¹å™¨ä¸­å–å‡ºuserDaoå¹¶ä¸”ç»™å…¶èµ‹å€¼
        userService.setUserDao(userDao);
        return userService;
    }
}
```

### @Autowired

ç±»ä¸­çš„æˆå‘˜å˜é‡å¯ä»¥é€šè¿‡@Autowiredæ³¨è§£æ³¨å†Œä¸ºç»„ä»¶ï¼Œæ­¤æ—¶è¯¥æˆå‘˜å˜é‡å°±ä¸éœ€è¦å¼€å‘äººå‘˜æ‰‹åŠ¨åˆå§‹åŒ–ã€‚@Autowiredçš„æœ¬è´¨æ˜¯åˆ©ç”¨å®¹å™¨æä¾›çš„setæ–¹æ³•ã€‚

```java
@Autowired
// å¦‚æœè¯¥ç±»å‹çš„ç»„ä»¶ä¸æ­¢ä¸€ä¸ªï¼Œéœ€è¦ä½¿ç”¨@Qualifieræ¥æŒ‡å®šç»„ä»¶çš„id
@Qualifier("userDaoImpl2")
UserDao userDao;
```

## ç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸ

ç»„ä»¶å¯ä»¥ä½¿ç”¨@Scopeæ³¨è§£æ¥ç¡®å®šè‡ªå·±çš„ä½œç”¨åŸŸã€‚å¦‚æœä½œç”¨åŸŸä¸ºsingletonï¼Œå³å•ä¾‹æ¨¡å¼ï¼Œé‚£ä¹ˆæ¯æ¬¡ä»å®¹å™¨ä¸­å–å‡ºçš„ç»„ä»¶éƒ½æ˜¯åŒä¸€ä¸ªç»„ä»¶ï¼›å¦‚æœä½¿ç”¨çš„æ˜¯prototypeï¼Œå³åŸå‹æ¨¡å¼ï¼Œé‚£ä¹ˆæ¯æ¬¡å–å‡ºçš„éƒ½æ˜¯æ–°çš„å®ä¾‹ã€‚Springé»˜è®¤ä½¿ç”¨å•ä¾‹æ¨¡å¼ã€‚

åœ¨å•ä¾‹æ¨¡å¼ä¸‹ï¼Œå®¹å™¨åˆå§‹åŒ–æ—¶å°±ä¼šå¼€å§‹ç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸï¼›å¦‚æœæ˜¯åŸå‹æ¨¡å¼ï¼Œåˆ™åªæœ‰åœ¨è·å¾—ç»„ä»¶æ—¶æ‰å¼€å§‹ç”Ÿå‘½å‘¨æœŸã€‚

ç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸå¦‚ä¸‹ã€‚

1. å®ä¾‹åŒ–ã€‚

2. ç»™æˆå‘˜å˜é‡èµ‹å€¼ã€‚ä¸€èˆ¬é€šè¿‡@Autowiredç­‰æ³¨è§£å®ç°ã€‚

3. è§‰é†’ï¼ˆAwareï¼‰ï¼Œå¦‚æœç»„ä»¶å®ç°äº†Awareç›¸å…³çš„æ¥å£ï¼Œåœ¨è¿™æ—¶ç»„ä»¶å°±å¯ä»¥é€šè¿‡è¯¥æ¥å£çš„setæ–¹æ³•è®¾ç½®ä¸€äº›æ•°æ®ã€‚æ¯”å¦‚ï¼Œå¦‚æœç»„ä»¶å®ç°äº†`BeanNameAware`æ¥å£ï¼Œé‚£ä¹ˆå°±å¯ä»¥è°ƒç”¨`setBeanName(String beanName)`æ–¹æ³•ã€‚

4. BeanPostProcessorï¼Œæä¾›äº†ä¸¤ä¸ªå®ç°æ–¹æ³•ï¼š`postProcessBeforeInitialization`å’Œ`postProcessAfterInitialization`ï¼Œå…¶ä½œç”¨èŒƒå›´ä¸ºæ‰€æœ‰æ³¨å†Œçš„ç»„ä»¶ã€‚æ­¤æ—¶è§¦å‘çš„æ˜¯beforeæ–¹æ³•ã€‚

5. InitializingBeançš„afterPropertiesSetæ–¹æ³• ï¼Œæˆ–æ˜¯è‡ªå®šä¹‰çš„initæ–¹æ³•ã€‚

   ```java
   @Override
   public void afterPropertiesSet() throws Exception {
       System.out.println("InitializingBeanæä¾›çš„initæ–¹æ³•");
   }
   
   // è‡ªå®šä¹‰initæ–¹æ³•ï¼Œæ–¹æ³•åè‡ªå·±å®šä¹‰
   @PostConstruct
   public void init() {
       System.out.println("è‡ªå®šä¹‰init");
   }
   ```

6. BeanPostProcessorçš„afteræ–¹æ³•ã€‚

7. ä½¿ç”¨ç»„ä»¶ã€‚

8. DisposableBeançš„destroyæ–¹æ³•ï¼Œæˆ–æ˜¯è‡ªå®šä¹‰çš„destroyæ–¹æ³•ã€‚

   ```java
   @Override
   public void destroy() throws Exception {
       System.out.println("DisposableBeanæä¾›çš„destroy");
   }
   
   @PreDestroy
   public void customDestroy() {
       System.out.println("è‡ªå®šä¹‰destroy");
   }
   ```

## AOP

AOPï¼Œé¢å‘åˆ‡é¢ç¼–ç¨‹ï¼Œå¯ä»¥å°†ä¸€äº›ä¸ä¸šåŠ¡æ— å…³ï¼Œä½†æ˜¯æ‰€æœ‰ä¸šåŠ¡éƒ½éœ€è¦è°ƒç”¨çš„é€»è¾‘å°è£…èµ·æ¥ï¼ˆå¦‚æ—¥å¿—ï¼Œæƒé™æ§åˆ¶ç­‰ï¼‰ï¼Œå°†å…¶ä½œä¸ºä¸€ç§å¢å¼ºã€‚AOPåŸºäºåŠ¨æ€ä»£ç†å®ç°ï¼Œä½†æ˜¯ç›¸æ¯”åŠ¨æ€ä»£ç†ï¼ŒAOPå¯ä»¥æ›´çµæ´»çš„ç­›é€‰éœ€è¦å¢å¼ºçš„æ–¹æ³•ä»¥åŠå¢å¼ºæ‰€è¦åšçš„ä¸šåŠ¡ã€‚

ç°åœ¨ä¸€èˆ¬ä½¿ç”¨AspectJæ¡†æ¶å®ç°AOPã€‚

### åˆ‡å…¥ç‚¹Pointcut

ä½¿ç”¨executionæŒ‡å®šéœ€è¦å¢å¼ºçš„æ–¹æ³•ã€‚

```xml
<aop:comfig>
<aop:pointcut id="mypointcut1" expression="execution(public void
com.cskaoyan.service.UserServiceImpl.sayHello(String))"/>
<aop:pointcut id="mypointcut2" expression="execution(* co*..say*(*))"/>
<aop:pointcut id="mypointcut3" expression="execution(*
co*.cskaoyan..UserServiceImpl.sayHello(..))"/>
</aop:config>
```

ä½¿ç”¨@annotationæŒ‡å®šç‰¹æ®Šçš„å¢å¼ºæ–¹æ³•ã€‚

```java
@Retention(RetentionPolicy.RUNTIME)
@Target(ElementType.METHOD)
public @interface CountTime {
}
```

```xml
<aop:config>
<!--ä½œç”¨åœºæ™¯ï¼šç»„ä»¶ä¸­çš„æ–¹æ³•ï¼ŒåŒ…å«è‡ªå®šä¹‰@CountTimeæ³¨è§£çš„æ–¹æ³•ç”Ÿæ•ˆ-->
<aop:pointcut id="mypointcut"
expression="@annotation(com.cskaoyan.CountTime)"/>
</aop:config>
```

### é€šçŸ¥å™¨Advisor

```xml
<!--advisor â†’ æ–°çš„æ ‡ç­¾ aopæ ‡ç­¾ â†’ å¼•å…¥aopçš„schemaçº¦æŸ-->
<aop:config>
    <aop:advisor advice-ref="countTimeInterceptor" pointcut="execution(public void com.cskaoyan.service.UserServiceImpl.sayHello(String))"/>
</aop:config>
```

### åˆ‡é¢Aspect

åˆ‡é¢æ˜¯ä¸Šé¢ä¸¤ç§çš„ç»“åˆï¼Œå³åœ¨æŒ‡å®šçš„åˆ‡å…¥ç‚¹å†™å…¥è‡ªå®šä¹‰çš„é€šçŸ¥ã€‚åˆ‡é¢æœ‰äº”ä¸ªé€šçŸ¥æ–¹æ³•ï¼Œåˆ†åˆ«æ˜¯Beforeã€Afterã€Aroundã€AfterReturningã€AfterThrowingã€‚Beforeå’ŒAfterè¡¨ç¤ºåœ¨è¯¥æ–¹æ³•çš„æ‰§è¡Œå‰åçš„é€šçŸ¥ï¼›Aroundç±»ä¼¼äºInvocationHandlerçš„`invoke()`å’ŒMethodInterceptorçš„`invoke()`ï¼Œå¯ä»¥åœ¨æ‰§è¡Œproceedæ–¹æ³•å‰åè¿›è¡Œæ“ä½œï¼ŒAroundä¹Ÿæ˜¯ä½¿ç”¨çš„æœ€å¤šçš„é€šçŸ¥ï¼›AfterReturningæ˜¯åœ¨æ–¹æ³•è¿”å›å€¼åä½¿ç”¨çš„é€šçŸ¥ï¼Œå¯ä»¥æ¥æ”¶æ–¹æ³•çš„è¿”å›å€¼ï¼›AfterThrowingæ˜¯åœ¨æ–¹æ³•æŠ›å‡ºå¼‚å¸¸åä½¿ç”¨çš„é€šçŸ¥ï¼Œå¯ä»¥æ¥æ”¶æ–¹æ³•çš„å¼‚å¸¸ã€‚

äº”ä¸ªé€šçŸ¥çš„å…ˆåé¡ºåºæ˜¯ï¼šBefore->Around->After/AfterThrowing->AfterReturning

å¯ä»¥ä½¿ç”¨@Aspectæ³¨è§£æŒ‡å®šä¸€ä¸ªç»„ä»¶ä¸ºåˆ‡é¢ç»„ä»¶ï¼Œä¸”åœ¨ç±»ä¸­çš„æ–¹æ³•è¦ä½¿ç”¨@Beforeã€@Afterã€@Aroundã€@AfterReturningã€@AfterThrowingæ³¨è§£ä¿®é¥°æ–¹æ³•ã€‚

@Aspect
@Component
public class CustomAspect {

```java
@Aspect
@Component
public class CustomAspect {

    //@Pointcutæ³¨è§£å¢åŠ åœ¨æ–¹æ³•ä¸Š â†’ valueå±æ€§å†™åˆ‡å…¥ç‚¹è¡¨è¾¾å¼ï¼Œæ–¹æ³•åä½œä¸ºåˆ‡å…¥ç‚¹çš„id
    @Pointcut("execution(* com.cskaoyan.service..*(..))")
    public void servicePointcut() {
    }

    // åˆ‡é¢ç»„ä»¶ä¸­çš„æ–¹æ³•ï¼Œä½œä¸ºå¯¹åº”çš„é€šçŸ¥æ–¹æ³• â†’ åœ¨å¯¹åº”çš„æ—¶é—´ç‚¹ä¸‹ä¼šæ‰§è¡Œåˆ°å¯¹åº”çš„æ–¹æ³•
    // é€šçŸ¥æ³¨è§£çš„valueå±æ€§ï¼šå¯ä»¥ç›´æ¥å†™åˆ‡å…¥ç‚¹è¡¨è¾¾å¼ï¼›ä¹Ÿå¯ä»¥å¼•ç”¨åˆ‡å…¥ç‚¹æ–¹æ³•
    @Before("servicePointcut()")
    public void beforex() {
        System.out.println("beforeæ–¹æ³•");
    }

    @After("servicePointcut()")
    public void after() {
        System.out.println("afteré€šçŸ¥æ–¹æ³•");
    }

    // Aroundé€šçŸ¥ â†’ æœ€å¼ºé€šçŸ¥ ï¼šè¿”å›å€¼ä¸ºObjectï¼Œè¦æœ‰å§”æ‰˜ç±»æ–¹æ³•çš„æ‰§è¡Œ
    // ç±»ä¼¼äºInvocationHandlerçš„invokeï¼Œç±»ä¼¼äºMethodInterceptorçš„invoke
    // æ‰§è¡Œå§”æ‰˜ç±»çš„æ–¹æ³•ï¼šProceedingJoinPoint proceedæ–¹æ³•
    @Around("servicePointcut()")
    public Object around(ProceedingJoinPoint joinPoint) throws Throwable {
        long start = System.currentTimeMillis();
        System.out.println("å¼€å§‹æ—¶é—´ï¼š" + start);

        Object proceed = joinPoint.proceed(); // æ‰§è¡Œå§”æ‰˜ç±»çš„æ–¹æ³•

        long end = System.currentTimeMillis();
        System.out.println("æ–¹æ³•æ‰§è¡Œæ—¶é—´ï¼š" + (end - start));
        return proceed; // å°±æ˜¯ä½œä¸ºä»£ç†å¯¹è±¡æ‰§è¡Œæ–¹æ³•çš„è¿”å›å€¼
    }

    // afterReturningé€šçŸ¥æ–¹æ³•çš„å½¢å‚ï¼Œé‡‡ç”¨Objectç±»å‹ï¼Œæ¥æ”¶å§”æ‰˜ç±»æ–¹æ³•çš„è¿”å›å€¼
    @AfterReturning(value = "servicePointcut()",returning = "result")
    public void afterReturning(Object result) {
        System.out.println("AfterReturningæ¥æ”¶åˆ°çš„ç»“æœï¼š" + result);
    }

    // public void afterThrowing(Exception exception) {
    @AfterThrowing(value = "servicePointcut()",throwing = "exception")
    public void afterThrowing(Throwable exception) {
        System.out.println("afterThrowingé€šçŸ¥ï¼š" + exception.getMessage());
    }
}
```

### è¿æ¥ç‚¹JoinPoint

åœ¨Beforeå’ŒAroundé€šçŸ¥æ‰§è¡Œè¿‡ç¨‹ä¸­å¯ä»¥è·å¾—JoinPointï¼Œé€šè¿‡å®ƒæ‹¿åˆ°ä¸€äº›ä¿¡æ¯ï¼Œè¿™æ„å‘³ç€åœ¨é€šçŸ¥ä¸­å¯ä»¥æœ‰æ›´å¤šæ“ä½œç©ºé—´ã€‚

joinPointå¯ä»¥ç›´æ¥å†™åœ¨é€šçŸ¥æ–¹æ³•çš„å½¢å‚ä¸­ï¼Œé€šè¿‡è°ƒç”¨å…¶æ–¹æ³•è·å–ä¿¡æ¯ã€‚

```java
@Before("servicePointcut()")
public void beforex(JoinPoint joinPoint) {
    // ä»£ç†ç±»
    Object proxy = joinPoint.getThis();
    // ç›®æ ‡ç±»ã€å§”æ‰˜ç±»å¯¹è±¡
    Object target = joinPoint.getTarget();
    // å‚æ•°
    Object[] args = joinPoint.getArgs();
    // æ–¹æ³•
    Signature signature = joinPoint.getSignature();
    String name = signature.getName();
    System.out.println("æ­£åœ¨æ‰§è¡Œçš„æ–¹æ³•ï¼š" + name);

    System.out.println("beforeæ–¹æ³•");
}
```

## Springäº‹åŠ¡

Springäº‹åŠ¡æœ‰ä¸‰ç§äº‹åŠ¡ä¼ æ’­è¡Œä¸ºï¼Œåˆ†åˆ«æ˜¯REQUIREDã€REQUIRES_NEWã€NESTEDã€‚

REQUIREDï¼šSpringé»˜è®¤ã€‚å¦‚æœå¤–å›´çš„æ–¹æ³•ä¸åŒ…å«äº‹åŠ¡ï¼Œé‚£ä¹ˆè¢«ä¿®é¥°çš„å†…éƒ¨æ–¹æ³•å°±æ·»åŠ ä¸€ä¸ªæ–°çš„äº‹åŠ¡ï¼›å¦‚æœå¤–å›´æ–¹æ³•åŒ…å«äº‹åŠ¡ï¼Œåˆ™å†…éƒ¨æ–¹æ³•åŠ å…¥è¯¥äº‹åŠ¡ï¼Œè¦ä¹ˆä¸€èµ·æäº¤è¦ä¹ˆä¸€èµ·å›æ»šã€‚

REQUIRES_NEWï¼šå¦‚æœå¤–å›´çš„æ–¹æ³•ä¸åŒ…å«äº‹åŠ¡ï¼Œé‚£ä¹ˆå†…éƒ¨æ–¹æ³•å°±æ·»åŠ ä¸€ä¸ªæ–°çš„äº‹åŠ¡ï¼›å¦‚æœå¤–å›´æ–¹æ³•åŒ…å«äº‹åŠ¡ï¼Œå†…éƒ¨æ–¹æ³•ä¹Ÿæ·»åŠ ä¸€ä¸ªäº‹åŠ¡ï¼Œä¸”è¯¥äº‹åŠ¡ä¸å¤–å›´çš„äº‹åŠ¡ç‹¬ç«‹ã€‚

NESTEDï¼šå¦‚æœå¤–å›´çš„æ–¹æ³•ä¸åŒ…å«äº‹åŠ¡ï¼Œé‚£ä¹ˆå†…éƒ¨æ–¹æ³•å°±æ·»åŠ ä¸€ä¸ªæ–°çš„äº‹åŠ¡ï¼›å¦‚æœå¤–å›´æ–¹æ³•åŒ…å«äº‹åŠ¡ï¼Œå†…éƒ¨æ–¹æ³•ä¹Ÿæ·»åŠ ä¸€ä¸ªäº‹åŠ¡ï¼Œä¸”è¯¥äº‹åŠ¡ä¸å¤–å›´çš„äº‹åŠ¡æˆåµŒå¥—å…³ç³»ã€‚

Springäº‹åŠ¡çš„å¼€å¯æ–¹å¼æœ‰ï¼š

1. PlatFormTransactionManagerï¼Œå¹³å°äº‹åŠ¡ç®¡ç†å™¨

   ```java
   public interface PlatformTransactionManager extends TransactionManager {
       // æ ¹æ®äº‹åŠ¡çš„å®šä¹‰ï¼Œè·å¾—äº‹åŠ¡çš„çŠ¶æ€ â†’ å¼€å¯äº‹åŠ¡
       TransactionStatus getTransaction(@Nullable TransactionDefinition var1) throws TransactionException;
   	// æäº¤ â†’ å‚æ•°æ˜¯TransactionStatus
       void commit(TransactionStatus var1) throws TransactionException;
   	// å›æ»š â†’ å‚æ•°æ˜¯TransactionStatus
       void rollback(TransactionStatus var1) throws TransactionException;
   }
   ```

2. TransactionTemplate 

   ```java
   public class TransferTransactionCallBack implements TransactionCallback {
   
       AccountMapper accountMapper;
       Integer fromId;
       Integer destId;
       Integer fromMoney;
       Integer destMoney;
   
       public TransferTransactionCallBack(AccountMapper accountMapper, Integer fromId, Integer destId, Integer fromMoney, Integer destMoney) {
           this.accountMapper = accountMapper;
           this.fromId = fromId;
           this.destId = destId;
           this.fromMoney = fromMoney;
           this.destMoney = destMoney;
       }
   
       @Override
       public Object doInTransaction(TransactionStatus transactionStatus) {
           // æ›´æ–°money
           int update1 = accountMapper.update(fromId, fromMoney);
           int i = 1 / 0;
           int update2 = accountMapper.update(destId, destMoney);
           return null;
       }
   }
   ```

3. åœ¨é…ç½®ç±»ä½¿ç”¨@EnableTransactionManagementæ³¨è§£å¼€å¯äº‹åŠ¡ï¼Œåœ¨éœ€è¦äº‹åŠ¡çš„ç±»æˆ–æ–¹æ³•ä¸­ä½¿ç”¨æ³¨è§£@Transactionalã€‚

   ```java
   @Transactional
   @Override
   public void transfer(int fromId, int destId, Integer money) {
       // æŸ¥è¯¢ç°æœ‰çš„moneyæ˜¯å¤šå°‘
       Integer fromMoney = accountMapper.select(fromId);
       Integer destMoney = accountMapper.select(destId);
   
       // è®¡ç®—è½¬è´¦åçš„moneyæ˜¯å¤šå°‘
       fromMoney -= money;
       destMoney += money;
   
       // æ›´æ–°money
       int update1 = accountMapper.update(fromId, fromMoney);
       int i = 1 / 0;
       int update2 = accountMapper.update(destId, destMoney);
   
   }
   ```

## SpringMVC

ä¼ ç»Ÿçš„Servletæ˜ å°„è¿‡ç¨‹ç¹çï¼Œéœ€è¦æˆ‘ä»¬è‡ªå·±å¤„ç†urlå’ŒServletçš„æ˜ å°„å…³ç³»ï¼Œå¹¶æ ¹æ®urlåˆ¤æ–­ã€åˆ†å‘æ¥å£è‡³ä¸åŒçš„æ–¹æ³•ä¸­ï¼Œä¸”è¯·æ±‚å‚æ•°ã€å“åº”ç»“æœéƒ½è¦è‡ªå·±æ‰‹åŠ¨æ‹†å°jsonã€‚åœ¨SpringMVCä¸­ï¼Œåˆ™åªç”±ä¸€ä¸ªServletï¼šDispatcherServletæ¥è§£å†³ä¸Šè¿°é—®é¢˜ã€‚

åœ¨SpringMVCä¸­çš„æµç¨‹å¦‚ä¸‹ã€‚

1. å®¢æˆ·ç«¯ï¼ˆæµè§ˆå™¨ï¼‰å‘é€è¯·æ±‚ï¼Œç›´æ¥è¯·æ±‚åˆ° `DispatcherServlet`ã€‚
2. `DispatcherServlet` æ ¹æ®è¯·æ±‚ä¿¡æ¯è°ƒç”¨ `HandlerMapping`ï¼Œè§£æè¯·æ±‚å¯¹åº”çš„ `Handler`ã€‚
3. è§£æåˆ°å¯¹åº”çš„ `Handler`ï¼ˆä¹Ÿå°±æ˜¯æˆ‘ä»¬å¹³å¸¸è¯´çš„ `Controller` æ§åˆ¶å™¨ï¼‰åï¼Œå¼€å§‹ç”± `HandlerAdapter` é€‚é…å™¨å¤„ç†ã€‚
4. `HandlerAdapter` ä¼šæ ¹æ® `Handler`æ¥è°ƒç”¨çœŸæ­£çš„å¤„ç†å™¨å¼€å¤„ç†è¯·æ±‚ï¼Œå¹¶å¤„ç†ç›¸åº”çš„ä¸šåŠ¡é€»è¾‘ã€‚
5. å¤„ç†å™¨å¤„ç†å®Œä¸šåŠ¡åï¼Œä¼šè¿”å›ä¸€ä¸ª `ModelAndView` å¯¹è±¡ï¼Œ`Model` æ˜¯è¿”å›çš„æ•°æ®å¯¹è±¡ï¼Œ`View` æ˜¯ä¸ªé€»è¾‘ä¸Šçš„ `View`ã€‚
6. `ViewResolver` ä¼šæ ¹æ®é€»è¾‘ `View` æŸ¥æ‰¾å®é™…çš„ `View`ã€‚
7. `DispaterServlet` æŠŠè¿”å›çš„ `Model` ä¼ ç»™ `View`ï¼ˆè§†å›¾æ¸²æŸ“ï¼‰ã€‚
8. æŠŠ `View` è¿”å›ç»™è¯·æ±‚è€…ï¼ˆæµè§ˆå™¨ï¼‰

åœ¨SpringMVCä¸­ï¼Œå¯ä»¥å®Œå…¨ä½¿ç”¨JavaConfigä»£æ›¿é…ç½®æ–‡ä»¶ï¼Œä¸»è¦æœ‰ï¼š

1. AACDSIï¼ˆAbstractAnnotationConfigDispatcherServletInitializerï¼‰

   ```java
   public class ApplicationInitializer extends AbstractAnnotationConfigDispatcherServletInitializer {
       
       // åŠ è½½Springçš„é…ç½®æ–‡ä»¶application.xml â†’ é…ç½®ç±»
       @Override
       protected Class<?>[] getRootConfigClasses() {
           return new Class[]{SpringConfiguration.class};
       }
   
       // åŠ è½½SpringMVCçš„é…ç½®æ–‡ä»¶application-mvc.xml â†’ é…ç½®ç±»
       @Override
       protected Class<?>[] getServletConfigClasses() {
           return new Class[]{MvcConfiguration.class};
       }
   
       // DispatcherServletçš„æ˜ å°„èŒƒå›´
       @Override
       protected String[] getServletMappings() {
           return new String[]{"/"};
       }
   }
   ```

2. Springé…ç½®ç±»ï¼Œç”¨@Configurationä¿®é¥°

   ```java
   @ComponentScan(value = "com.cskaoyan",
           excludeFilters = @ComponentScan.Filter({Controller.class, EnableWebMvc.class})) // mvcé…ç½®ç±»ä¹Ÿåœ¨æ‰«æåŒ…èŒƒå›´
   @Configuration
   public class SpringConfiguration {
   }
   ```

3. SpringMVCé…ç½®ç±»ï¼Œç”¨@EnableWebMvcä¿®é¥°

   ```java
   @ComponentScan("com.cskaoyan.controller")
   @EnableWebMvc
   public class MvcConfiguration implements WebMvcConfigurer {
   }
   ```

### @RequestMapping

ç”¨äºurlçš„è·¯å¾„æ˜ å°„ï¼Œå¯ä»¥å†™åœ¨ç±»æˆ–æ–¹æ³•ä¸Šã€‚

åŒä¸€ä¸ªRequestMappingå¯ä»¥æ˜ å°„å¤šä¸ªè·¯å¾„ï¼Œé€šè¿‡æ•°ç»„è¡¨ç¤ºã€‚

```java
	@RequestMapping({"hello","hello2","hello3"})
    @ResponseBody
    public String hello() {
        return "hello world";
    }

	/**
     * ä¹Ÿå¯ä»¥ä½¿ç”¨é€šé…ç¬¦ *
     */
    @RequestMapping({"goodbye/*", "goodbye*"})
    @ResponseBody
    public String goodbye() {
        return "byebye";
    }
```

å¦‚æœè¯·æ±‚urlåŒ…å«å…±åŒçš„å‰ç¼€ï¼Œå¯ä»¥æå–è‡³ä¿®é¥°ç±»çš„æ³¨è§£ä¸­ï¼Œè¿™ç§°ä¸ºçª„åŒ–è¯·æ±‚ã€‚

```java
@Controller
@RequestMapping("user")
public class UserController {

    //@RequestMapping("user/login")
    @RequestMapping("login") 
    @ResponseBody
    public String login() {
        return "login";
    }
    //@RequestMapping("user/register")
    @RequestMapping("register")
    @ResponseBody
    public String register() {
        return "register";
    }
    //@RequestMapping("user/modify")
    @RequestMapping("modify")
    @ResponseBody
    public String modify() {
        return "modify";
    }
    //@RequestMapping("user/remove")
    @RequestMapping("remove")
    @ResponseBody
    public String remove() {
        return "remove";
    }
}
```

@RequestMappingè¿˜æœ‰å¤šç§å±æ€§ï¼š

* methodï¼šç”¨äºé™å®šè¯·æ±‚æ–¹æ³•ã€‚å¦‚GETã€POSTã€‚

  ```java
  	@RequestMapping(value = "get",method = RequestMethod.GET)
      @ResponseBody
      public String methodGet() {
          return "Method GET";
      }
  ```

* paramsï¼šç”¨äºé™å®šå‚æ•°ã€‚

  ```java
  	@RequestMapping(value = "login",params = {"username","password"}) // æ—¢è¦æºå¸¦usernameåˆè¦æºå¸¦password
      @ResponseBody
      public String login() {
          return "ok";
      }
  ```

* headersï¼šç”¨äºé™å®šè¯·æ±‚å¤´ã€‚

  ```java
   	@RequestMapping(value = "limit", headers = {"abc", "def"})//æ—¢è¦æºå¸¦abcã€åˆè¦æºå¸¦defè¿™ä¸¤ä¸ªè¯·æ±‚å¤´
      @ResponseBody
      public String headerLimit() {
          return "header limit";
      }
  ```

* consumesï¼šç”¨äºé™å®šContent-Typeçš„å€¼ã€‚

* producesï¼šç”¨äºé™å®šAcceptçš„å€¼

### @ResponseBody

åœ¨Controllerä¸Šæ·»åŠ æ³¨è§£@ResponseBodyï¼Œå³å¯å°†è¿”å›å€¼è‡ªåŠ¨åŒ…è£…ä¸ºjsonã€‚

```java
@Controller
public class JsonController {

    @RequestMapping("json")
    @ResponseBody
    public User json() {
        return new User("123","456");
    }
}
```

å¯ä»¥ä½¿ç”¨@RestControlleræ¥ä»£æ›¿@Controllerå’Œ @ResponseBodyã€‚

### è¯·æ±‚å‚æ•°çš„æ¥æ”¶

å¦‚æœæ˜¯æ™®é€šçš„getè¯·æ±‚ï¼Œå¯ä»¥ä½¿ç”¨æ–¹æ³•å½¢å‚æ¥æ¥æ”¶å‚æ•°ï¼Œä½†è¦æ±‚å½¢å‚åä¸å‚æ•°åå¿…é¡»ä¸€è‡´ã€‚ç±»å‹æ”¯æŒï¼š

* å­—ç¬¦ä¸²String
* åŸºæœ¬ç±»å‹ä»¥åŠå¯¹åº”åŒ…è£…ç±»
* æ•°ç»„
* Dateï¼ˆéœ€è¦ä½¿ç”¨@DateTimeFormatæ¥æ ‡å‡†åŒ–æ—¥æœŸæ ¼å¼ï¼‰
* æ–‡ä»¶

```java
@RequestMapping("register5")
public BaseRespVo register5(String username, String password, Integer age,
                            String[] hobbies, Integer[] ids,
                            @DateTimeFormat(pattern = "yyyy-MM-dd") Date birthday) {
    return BaseRespVo.ok();
}

@RequestMapping("file")
public BaseRespVo uploadFile(MultipartFile file) throws IOException {
    // è·å¾—ä¸Šä¼ çš„æ–‡ä»¶çš„ä¿¡æ¯
    String name = file.getName(); // è¯·æ±‚å‚æ•°å â†’ file
    String originalFilename = file.getOriginalFilename(); //åŸå§‹æ–‡ä»¶å
    long size = file.getSize(); // æ–‡ä»¶çš„å¤§å°
    String contentType = file.getContentType(); // æ­£æ–‡ç±»å‹ â†’ æ–‡ä»¶ç±»å‹
    // MultipartFile.transferTo
    File saveFile = new File("D:\\WorkSpace\\j40_workspace", originalFilename);
    //File saveFile = new File("D:\\WorkSpace\\j40_workspace\\dlrb.jpg");
    file.transferTo(saveFile);
    return BaseRespVo.ok();
}
```

é™¤äº†å½¢å‚ï¼Œè¿˜å¯ä»¥ä½¿ç”¨è‡ªå®šä¹‰çš„å¼•ç”¨ç±»å‹å¯¹è±¡ï¼Œå¦‚æœä½¿ç”¨å¼•ç”¨ç±»å‹çš„å¯¹è±¡æ—¶ï¼ŒServletä¼šå»åˆ›å»ºä¸€ä¸ªæ–°çš„å®ä¾‹ã€‚çœ‹ä½ è¿™ä¸ªç±»ä¸­æœ‰å“ªäº›æˆå‘˜å˜é‡ï¼Œå¦‚æœæˆå‘˜å˜é‡åå’Œè¯·æ±‚å‚æ•°åç›¸åŒï¼Œå°±ä¼šä½¿ç”¨æˆå‘˜å˜é‡æ¥æ¥æ”¶è¯·æ±‚å‚æ•°ï¼Œä½¿ç”¨setæ–¹æ³•æ¥è¿›è¡Œå°è£…ã€‚æ‰€ä»¥è¦æ±‚è¯·æ±‚å‚æ•°åä¸å¼•ç”¨ç±»ä¸­çš„æˆå‘˜å˜é‡åä¸€è‡´ã€‚

```java
@Data
public class User {
    String username;
   String password;
   Integer age;
    String[] hobbies;
   Integer[] ids;
    @DateTimeFormat(pattern = "yyyy-MM-dd")
    Date birthday;
}
```

```java
@RequestMapping("register6")
public BaseRespVo register6(User user) {
	return BaseRespVo.ok();
}
```

å¦‚æœæ˜¯postè¯·æ±‚ï¼Œé‚£ä¹ˆå‘é€çš„è¯·æ±‚å‚æ•°ä¸€èˆ¬æ˜¯jsonï¼Œéœ€è¦å¯¹jsonè½¬æ¢æˆå¯¹åº”çš„å®ä¾‹ã€‚æ­¤æ—¶éœ€è¦å¢åŠ @RequestBodyæ³¨è§£æ¥ä¿®é¥°jsonå¯¹åº”çš„beanç±»ã€‚

```java
@RequestMapping("user/login")
public BaseRespVo login(@RequestBody JsonUser user) {
    return BaseRespVo.ok(user);
}
```

å¦‚æœéœ€è¦è·å¾—Cookieï¼Œåˆ™ä¸èƒ½ç›´æ¥è·å¾—ï¼Œéœ€è¦é€šè¿‡Requestè·å¾—ã€‚

```java
// æŠŠæ‰€æœ‰Cookieéƒ½éå†æ‰“å°ä¸€ä¸‹
@RequestMapping("cookies")
public BaseRespVo cookies(HttpServletRequest request) {
    Cookie[] cookies = request.getCookies();
    for (Cookie cookie : cookies) {
        System.out.println(cookie.getName() + " --> " + cookie.getValue());
    }

    return BaseRespVo.ok();
}
```

è€Œsessionå¯ä»¥ç›´æ¥è·å¾—ã€‚

```java
@RequestMapping("session2")
public BaseRespVo session2(HttpSession session) {
    Object username = session.getAttribute("username");
    return BaseRespVo.ok(username);
}
```

### @PathVariable

è·å–è¯·æ±‚urlä¸­æŒ‡å®šå ä½ç¬¦çš„å€¼ï¼Œå¹¶å°†å€¼èµ‹ç»™å¯¹åº”çš„å½¢å‚ã€‚

```java
@RequestMapping("note/{id}")
public BaseRespVo note(@PathVariable("id") Integer id) {
    return BaseRespVo.ok();
}
```

### Converter

Converterï¼Œç±»å‹è½¬æ¢å™¨ï¼Œä½¿ç”¨ä¸»è¦æ˜¯åœ¨è¯·æ±‚å‚æ•°å°è£…çš„è¿‡ç¨‹ä¸­ï¼Œä¹Ÿå°±æ˜¯Handleræ–¹æ³•çš„å½¢å‚ã€‚åœ¨å½¢å‚å¹¶ä¸æ˜¯Stringçš„æƒ…å†µä¸‹ä¼šç”¨åˆ°Converterã€‚

ä¸€èˆ¬æƒ…å†µä¸‹éœ€è¦è‡ªå·±å®šä¹‰Converterã€‚å¦‚ä»Stringè½¬ä¸ºUserã€‚

```java
public class String2UserConverter implements Converter<String, User> {
    @Override
    public User convert(String s) {
        // é‡Œé¢çš„è½¬æ¢ä¸šåŠ¡éœ€è¦ä½ è‡ªå·±å®šä¹‰
        User user = new User();
        user.setUsername(s);
        user.setPassword(s);
        return user;
    }
}
```

```java
// æä¾›è‡ªå®šä¹‰çš„è½¬æ¢å™¨
@Override
public void addFormatters(FormatterRegistry registry) {
    registry.addConverter(new String2UserConverter());
}
```

### ResourceHandler

å› ä¸ºåœ¨SpringMVCä¸­ï¼ŒDispatcherServletçš„æ˜ å°„èŒƒå›´æ˜¯/ï¼Œå³é™¤äº†jspå¤–çš„æ‰€æœ‰è¯·æ±‚ï¼Œä¹‹å‰JavaEEçš„è®¿é—®é™æ€èµ„æºçš„æ–¹å¼å°±æ— æ³•ä½¿ç”¨äº†ï¼Œæ‰€ä»¥éœ€è¦ä½¿ç”¨ResourceHandleræ¥è¿›è¡Œé™æ€èµ„æºæ˜ å°„ã€‚

```java
@Override
public void addResourceHandlers(ResourceHandlerRegistry registry) {
   registry.addResourceHandler("/pic/**").addResourceLocations("classpath:/");
   registry.addResourceHandler("/jpg/**").addResourceLocations("/");
	registry.addResourceHandler("/png/**").addResourceLocations("file:D:\\spring/");
}
```

### HandlerInterceptor

åœ¨Handlerå‰æ‰§è¡Œï¼Œèµ·åˆ°äº†æ‹¦æˆªçš„åŠŸèƒ½ã€‚

```java
public interface HandlerInterceptor {
    // åœ¨Handleræ–¹æ³•æ‰§è¡Œä¹‹å‰
    // è¿”å›å€¼ä¸ºbooleanï¼Œå¦‚æœä¸ºtrueåˆ™ç»§ç»­æµç¨‹ï¼Œå¦‚æœfalseï¼Œåˆ™ä¸­æ–­æµç¨‹
    default boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {
        return true;
    }
	// åœ¨Handleræ–¹æ³•æ‰§è¡Œä¹‹å
    default void postHandle(HttpServletRequest request, HttpServletResponse response, Object handler, @Nullable ModelAndView modelAndView) throws Exception {
    }
	// åœ¨æ•´ä¸ªæµç¨‹å®Œæˆä¹‹å
    default void afterCompletion(HttpServletRequest request, HttpServletResponse response, Object handler, @Nullable Exception ex) throws Exception {
    }
}
```

### å¼‚å¸¸å¤„ç†

æœ‰ä¸¤ç§å¼‚å¸¸å¤„ç†æ–¹å¼ï¼šç»Ÿä¸€çš„å…¨å±€å¼‚å¸¸å¤„ç† HandlerExceptionResolverå’Œè‡ªå®šä¹‰å¼‚å¸¸å¤„ç† ExceptionHandlerã€‚

HandlerExceptionResolveræ˜¯ä¸€ä¸ªæ¥å£ï¼Œæ¥å£é‡Œæä¾›äº†resolveExceptionæ–¹æ³•ï¼Œé‡å†™è¯¥æ–¹æ³•æ¥å¤„ç†å…¨å±€å¼‚å¸¸ã€‚

```java
@Component
public class CustomHandlerExceptionResolver implements HandlerExceptionResolver {
    @Override
    public ModelAndView resolveException(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse, Object o, Exception e) {
        // é€šè¿‡å®ƒä¹Ÿå¯ä»¥åšä¸ªæ€§åŒ–çš„å¼‚å¸¸å¤„ç†ï¼Œå¦‚æœè¦åšï¼Œéœ€è¦ä½ è‡ªå·±æ¥åšä¸ªæ€§åŒ–çš„ä¸œè¥¿
        if (e instanceof ArithmeticException) {
            //åšä¸ªæ€§åŒ–çš„å¼‚å¸¸å¤„ç†
            System.out.println(e.getMessage());
        }
        return new ModelAndView("/exception.jsp");
    }
}
```

ExceptionHandleræ˜¯ä¸€ä¸ªæ³¨è§£ï¼Œvalueæ˜¯å¯¹åº”çš„å¼‚å¸¸ï¼Œæ—¨åœ¨ç”¨å¯¹åº”çš„æ–¹æ³•å¤„ç†å¯¹åº”çš„å¼‚å¸¸ã€‚ä¸€èˆ¬æ”¾åœ¨ontrollerAdviceç»„ä»¶ä¸­çš„æ–¹æ³•ä¸Šã€‚

```java
@ControllerAdvice
public class CustomExceptionControllerAdvice {

    // åœ¨å½¢å‚ä¸­å¯ä»¥ç›´æ¥æ¥æ”¶ä½ æŠ›å‡ºçš„å¼‚å¸¸ï¼Œä½ æ˜ å°„çš„æ˜¯ä»€ä¹ˆå¼‚å¸¸ï¼Œå°±å¯ä»¥ä»¥ä»€ä¹ˆç±»å‹çš„å½¢å‚æ¥æ¥æ”¶
    @ExceptionHandler(ArithmeticException.class)
    @ResponseBody
    public BaseRespVo method1(ArithmeticException exception) {
        return BaseRespVo.fail(exception.getMessage());
    }
    
}
```

## SpringBoot

SpringBootæœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ªSpringæ¡†æ¶ï¼Œä½†æ˜¯å®ƒç®€åŒ–äº†Springçš„é…ç½®ã€‚åœ¨æ²¡æœ‰ç»™å…·ä½“é…ç½®å‰ï¼ŒSpringBootä¼šä½¿ç”¨é»˜è®¤çš„é…ç½®ï¼Œåªæœ‰ç»™åˆ°å…·ä½“çš„é…ç½®ï¼Œæ‰é‡‡ç”¨å…·ä½“çš„é…ç½®ã€‚

å¯åŠ¨ç±»ï¼š

```java
// è¯¥æ³¨è§£å°±æ˜¯SpringBootåº”ç”¨å¯åŠ¨ç±»ä¸Šçš„æ³¨è§£ â†’ ä¼šé…ç½®æ‰«æåŒ…ç›®å½•å°±æ˜¯è¯¥ç±»æ‰€å¤„çš„åŒ…ç›®å½•
@SpringBootApplication
public class Demo1FirstSbApplication {
    // å¯åŠ¨ç±»ä¸­ä¸€å®šä¼šåŒ…å«mainæ–¹æ³• â†’ å°±æ˜¯å¯åŠ¨SpringBootåº”ç”¨ç¨‹åºçš„å…¥å£
    public static void main(String[] args) {
        SpringApplication.run(Demo1FirstSbApplication.class, args);
    }

}
```

SpringBootå¯¹webçš„æ”¯æŒï¼š

```yaml
# tomcaté…ç½®
server:
  port: 8083  #Tomcatçš„ç«¯å£å·é…ç½®
  servlet:
    context-path: /demo1   # åº”ç”¨ç¨‹åºçš„ä¸Šä¸‹æ–‡é…ç½®ï¼ˆåº”ç”¨åï¼‰
    
# é™æ€èµ„æºæ˜ å°„
spring:
  mvc:
    static-path-pattern: /pic/**
#  spring.resources  æˆ–  spring.web.resources
  resources:
    static-locations: file:d:/spring/
    
# Converter
# Filter
```

SpringBootå¯¹Mybatisçš„æ”¯æŒï¼š

```yaml
spring:
  datasource:
    driver-class-name: com.mysql.jdbc.Driver
    url: jdbc:mysql://localhost:3306/cskaoyan_db?useUnicode=true&characterEncoding=utf-8
    username: root
    password: 123456
```

```java
@SpringBootApplication
// éœ€è¦æ·»åŠ @MapperScanæ¥æ‰«æmapper
@MapperScan("com.cskaoyan.mapper")
public class Demo1FirstSbApplication {

    public static void main(String[] args) {
        SpringApplication.run(Demo1FirstSbApplication.class, args);
    }

}
```

## é€†å‘å·¥ç¨‹

é€†å‘å·¥ç¨‹å¯ä»¥æ ¹æ®æ•°æ®åº“ä¸­çš„è¡¨è‡ªåŠ¨ç”Ÿæˆæ¥å£ã€æ–¹æ³•ã€æ˜ å°„æ–‡ä»¶ï¼Œåªéœ€è¦æ“ä½œå¯¹åº”çš„Exampleç±»å°±å¯ä»¥æ“ä½œæ•°æ®åº“ã€‚

æ¥å£æ–¹æ³•ç¤ºä¾‹ã€‚

```java
//å‡åºè¿˜æ˜¯é™åº:å­—æ®µ+ç©ºæ ¼+asc(desc)
protected String orderByClause;
//å»é™¤é‡å¤:trueæ˜¯é€‰æ‹©ä¸é‡å¤è®°å½•,false,åä¹‹
protected boolean distinct;
//è‡ªå®šä¹‰æŸ¥è¯¢æ¡ä»¶
protected List<Criteria> oredCriteria;
```

```java
@Test
public void testFindUserByName(){

    //é€šè¿‡criteriaæ„é€ æŸ¥è¯¢æ¡ä»¶
    UserExample userExample = new UserExample();
    userExample.setOrderByClause("username asc"); //ascå‡åº,descé™åºæ’åˆ—
    userExample.setDistinct(false); //å»é™¤é‡å¤,trueæ˜¯é€‰æ‹©ä¸é‡å¤è®°å½•,falseåä¹‹
    UserExample.Criteria criteria = userExample.createCriteria(); //æ„é€ è‡ªå®šä¹‰æŸ¥è¯¢æ¡ä»¶
    criteria.andUsernameEqualTo("å¼ ä¸‰");

    //è‡ªå®šä¹‰æŸ¥è¯¢æ¡ä»¶å¯èƒ½è¿”å›å¤šæ¡è®°å½•,ä½¿ç”¨Listæ¥æ”¶
    List<User> users = userMapper.selectByExample(userExample);

    System.out.println(users);
} 
```

é€†å‘å·¥ç¨‹ç”Ÿæˆçš„å†…å®¹ä¼šæœ‰ä¸€å®šé—®é¢˜ï¼Œå¦‚æœè¡¨ä¸­çš„å­—æ®µå­˜åœ¨sqlè¯­å¥ä¸­çš„å…³é”®å­—ï¼Œéœ€è¦è‡ªå·±æ‰‹åŠ¨åœ¨mapper.xmlæ–‡ä»¶ä¸­æ·»åŠ è½¬ä¹‰å­—ç¬¦ã€‚

## TypeHandler

TypeHandleræ˜¯Mybatisè¾“å…¥è¾“å‡ºæ˜ å°„è¿‡ç¨‹ä¸­çš„ç±»å‹å¤„ç†å™¨ï¼Œç”¨äºå¤„ç†jdbcTypeå’ŒJavaTypeé—´çš„è½¬æ¢ã€‚

ä¸»è¦æ–¹å¼æ˜¯å®ç°`TypeHandler`æ¥å£ã€‚

```java
// ç±»å‹æ˜ å°„é…ç½®
@MappedTypes(Integer[].class)
@MappedJdbcTypes(JdbcType.VARCHAR)
public class IntegerArrayTypeHandler implements TypeHandler<Integer[]> {

    ObjectMapper objectMapper = new ObjectMapper();
    
    // è¾“å…¥æ˜ å°„è¿‡ç¨‹
    // insert into market_user (id,username,password,role_ids) values (?,?,?,?)
    @Override
    public void setParameter(PreparedStatement preparedStatement, int index, Integer[] integers, JdbcType jdbcType) throws SQLException {
        String value = null;
        try {
            value = objectMapper.writeValueAsString(integers);
        } catch (JsonProcessingException e) {
            e.printStackTrace();
        }
        // ä¸ºç¬¬å‡ ä¸ªå ä½ç¬¦æä¾›çš„å€¼æ˜¯ä»€ä¹ˆ
        preparedStatement.setString(index,value);
    }

    // è¾“å‡ºæ˜ å°„è¿‡ç¨‹
    @Override
    public Integer[] getResult(ResultSet resultSet, String columName) throws SQLException {
        // è·å¾—ç»“æœ
        String result = resultSet.getString(columName);
        return transfer(result);
    }

    @Override
    public Integer[] getResult(ResultSet resultSet, int index) throws SQLException {
        // è·å¾—ç»“æœ
        String result = resultSet.getString(index);
        return transfer(result);
    }

    @Override
    public Integer[] getResult(CallableStatement callableStatement, int i) throws SQLException {
        // è·å¾—ç»“æœ
        String result = callableStatement.getString(i);
        return transfer(result);
    }

    private Integer[] transfer(String result) {
        Integer[] integers = new Integer[0];
        // ä½¿ç”¨jacksonå°†å­—ç¬¦ä¸²è½¬æ¢Integer[]
        try {
            integers = objectMapper.readValue(result, Integer[].class);
        } catch (JsonProcessingException e) {
            e.printStackTrace();
        }
        return integers;
    }
}
```

é…ç½®è‡ªå®šä¹‰çš„TypeHandler

```yaml
mybatis:
  type-handlers-package: com.cskaoyan.typehandler
```

## Shiroæ¡†æ¶

Shiroå®‰å…¨æ¡†æ¶ï¼ŒApache Shiroæ˜¯ä¸€ä¸ªå¼€æºå®‰å…¨æ¡†æ¶ï¼Œæä¾›èº«ä»½è®¤è¯ã€æˆæƒã€å¯†ç å­¦å’Œä¼šè¯ç®¡ç†ã€‚Shiroæ¡†æ¶ç›´è§‚ã€æ˜“ç”¨ï¼ŒåŒæ—¶ä¹Ÿèƒ½æä¾›å¥å£®çš„å®‰å…¨æ€§ã€‚

Shiroåœ¨SpringMVCåº”ç”¨ç¨‹åºä¸­ä»¥Filterçš„å½¢å¼å­˜åœ¨ã€‚

Shiroçš„ä¸€äº›æ ¸å¿ƒæœ¯è¯­å¦‚ä¸‹ã€‚

* Authenticationï¼Œè®¤è¯æ˜¯èº«ä»½éªŒè¯çš„è¿‡ç¨‹ -æ‚¨æ­£åœ¨å°è¯•è¯æ˜ç”¨æˆ·æ˜¯ä»–ä»¬æ‰€è¯´çš„äººã€‚ä¸ºæ­¤ï¼Œç”¨æˆ·éœ€è¦æä¾›ç³»ç»Ÿç†è§£å’Œä¿¡ä»»çš„æŸç§èº«ä»½è¯æ˜ã€‚è®¤è¯å…¶å®å°±æ˜¯æˆ‘ä»¬é€šå¸¸æ‰€è¯´çš„ç™»å½•ã€‚
* Authorizationï¼Œæˆæƒæˆ–è®¿é—®æ§åˆ¶æ˜¯æŒ‡å®šå¯¹èµ„æºçš„è®¿é—®æƒé™çš„åŠŸèƒ½ã€‚æ¢å¥è¯è¯´ï¼Œè°å¯ä»¥è®¿é—®ä»€ä¹ˆã€‚æ¯”å¦‚æ˜¯å¦å…è®¸ç”¨æˆ·ç¼–è¾‘æ­¤æ•°æ®ï¼Œè¿™äº›éƒ½æ˜¯å†³å®šç”¨æˆ·æœ‰æƒè®¿é—®çš„å†…å®¹çš„å†³å®šã€‚æˆ‘ä»¬å½“å‰ä¸»è¦é’ˆå¯¹çš„æ˜¯URLçº§åˆ«çš„æƒé™è®¿é—®æ§åˆ¶ã€‚
* Subjectï¼Œä¸»ä½“ï¼Œåœ¨Shiroä¸­æ‰€åšçš„å‡ ä¹æ‰€æœ‰æ“ä½œéƒ½åŸºäºå½“å‰æ­£åœ¨æ‰§è¡Œçš„ç”¨æˆ·ï¼Œä¹Ÿå°±æ˜¯åŸºæœ¬ä¸ŠShiroçš„æ“ä½œéƒ½æ˜¯ä½¿ç”¨Subjectæ“ä½œçš„ï¼ŒSubjectæŒ‡çš„å°±æ˜¯å½“å‰æ“ä½œçš„ç”¨æˆ·ã€‚åœ¨ä»£ç ä¸­çš„ä»»ä½•ä½ç½®éƒ½å¯ä»¥è½»æ¾è·å¾—Subjectï¼Œé€šè¿‡Subjectå¯ä»¥æ–¹ä¾¿çš„æ“ä½œShiroã€‚æ¯”å¦‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨Subjectæä¾›çš„æ–¹æ³•æ¥æ‰§è¡Œè®¤è¯ã€åˆ¤æ–­æ˜¯å¦è®¤è¯ç­‰æ“ä½œã€‚
* Principalsï¼Œä¸»ä½“é‰´å®šåçš„å‚æ•°ï¼Œä¹Ÿå°±æ˜¯è®¤è¯åçš„ç”¨æˆ·ä¿¡æ¯ï¼Œå¯ä»¥æ˜¯å§“åã€ç”¨æˆ·idã€ç”¨æˆ·å¯¹è±¡ç­‰å½¢å¼ã€‚
* Credentialsï¼Œç”¨æ¥éªŒè¯èº«ä»½çš„ç§˜å¯†æ•°æ®ï¼Œé€šå¸¸æŒ‡å¯†ç ï¼Œç”Ÿç‰©æ•°æ®æ¯”å¦‚æŒ‡çº¹ã€é¢éƒ¨ã€ç³å­”ç­‰ã€‚
* Realmsï¼ŒåŸŸæˆ–é¢†åŸŸï¼Œå®‰å…¨çš„ç‰¹æ®Šæ•°æ®å­˜å‚¨å¯¹è±¡ï¼ˆDAOï¼‰ï¼ŒShiroä¸­çš„Realmä¸»è¦æ˜¯è®©ä½ èƒ½å¤Ÿè·å¾—å¯¹åº”çš„è®¤è¯ä¿¡æ¯å’Œæˆæƒä¿¡æ¯ã€‚
* Tokenï¼Œä»¤ç‰Œï¼ŒShiroä¸­çš„Tokenæ˜¯ä½œä¸ºç™»å½•æ“ä½œçš„å‚æ•°ã€‚

Shiroçš„æ ¸å¿ƒç»„ä»¶å¦‚ä¸‹ï¼š

* SecurityManagerï¼Œå®‰å…¨ç®¡ç†å™¨
* Authenticatorï¼Œè®¤è¯å™¨
* SessionManagerï¼Œä¼šè¯ç®¡ç†å™¨
* Realmï¼ŒåŸŸ
* CacheManagerï¼Œç¼“å­˜ç®¡ç†å™¨
* Cryptographyï¼Œå¯†ç å­¦

Shiroæä¾›çš„Filterç±»å‹å¦‚ä¸‹ã€‚

| Filteråç§° | Filterç±»                                                     | è¯´æ˜                                           |
| ---------- | ------------------------------------------------------------ | ---------------------------------------------- |
| anon       | org.apache.shiro.web.filter.authc.AnonymousFilter            | åŒ¿åFilterï¼Œä½œç”¨èŒƒå›´å†…çš„è¯·æ±‚ä¸éœ€è¦è®¤è¯å’Œæˆæƒ   |
| authc      | org.apache.shiro.web.filter.authc.FormAuthenticationFilter   | è®¤è¯Filterï¼Œä½œç”¨èŒƒå›´å†…çš„è¯·æ±‚éœ€è¦å®Œæˆè®¤è¯       |
| perms      | org.apache.shiro.web.filter.authz.PermissionsAuthorizationFilter | æƒé™Filterï¼Œä½œç”¨èŒƒå›´å†…çš„è¯·æ±‚éœ€è¦å®Œæˆè®¤è¯å’Œæˆæƒ |

æˆ‘ä»¬å¯ä»¥è®¾ç½®ä¸åŒç±»å‹çš„Filteråˆ†åˆ«æ˜ å°„ä¸€äº›ä¸åŒçš„URLèŒƒå›´ï¼Œå½“è¯·æ±‚å‘é€åˆ°åº”ç”¨ç¨‹åºæ—¶ï¼Œæ ¹æ®è¯·æ±‚URLåˆ†åˆ«åˆ¤æ–­ä½¿ç”¨å“ªä¸€äº›Filterï¼Œåœ¨Filterä¸­å†³å®šæ˜¯å¦ç»§ç»­è®¿é—®æµç¨‹ã€‚åœ¨SpringBootä¸­ï¼Œä¸»è¦åœ¨é…ç½®æ–‡ä»¶ä¸­é…ç½®ã€‚

### Realm

Shiroä¸­çš„Realmä¸»è¦æ˜¯è®©ä½ èƒ½å¤Ÿè·å¾—å¯¹åº”çš„è®¤è¯ä¿¡æ¯å’Œæˆæƒä¿¡æ¯ã€‚

ä¸€èˆ¬é€šè¿‡è‡ªå®šä¹‰Realmæ¥ä½¿ç”¨ï¼Œéœ€è¦ç»§æ‰¿ä¸€ä¸ªæŠ½è±¡ç±»AuthorizingRealmï¼Œå¹¶å®ç°ä¸¤ä¸ªæŠ½è±¡æ–¹æ³•ï¼š

* doGetAuthenticationInfo ï¼šè·å¾—è®¤è¯ä¿¡æ¯ï¼Œå³æ ¹æ®tokenä¸­çš„ç”¨æˆ·åæŸ¥è¯¢è¯¥ç”¨æˆ·åœ¨ç³»ç»Ÿä¸­çš„Credentialsï¼Œå¹¶ä¸”æ„é€ AuthenInfoã€‚
* doGetAuthorizationInfo ï¼šè·å¾—æˆæƒä¿¡æ¯ï¼Œå³æ ¹æ®Principalï¼ˆæ”¾å…¥AuthenInfoä¸­çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼‰æŸ¥è¯¢è¯¥ç”¨æˆ·åœ¨ç³»ç»Ÿä¸­çš„æƒé™ä¿¡æ¯ã€‚

åœ¨è¿™ä¸¤ä¸ªæ–¹æ³•ä¸­å»å†™è·å¾—ç”¨æˆ·è®¤è¯ä¿¡æ¯å’Œæˆæƒä¿¡æ¯çš„ä¸šåŠ¡ä»£ç ã€‚

```java
@Component
public class CustomRealm extends AuthorizingRealm {
    //é€šå¸¸æŠŠdoGetAuthenticationInfoæ–¹æ³•æ”¾åœ¨ä¸Šé¢

    //è¯¥æ–¹æ³•çš„å½¢å‚ â†’ æ¥æºäºsubjectçš„loginæ–¹æ³•
    // ä¼ å…¥è¯¥å€¼ï¼Œä¸ºäº†æ ¹æ®ç”¨æˆ·åæŸ¥è¯¢åˆ°è¯¥ç”¨æˆ·åœ¨ç³»ç»Ÿä¸­çš„å¯†ç ï¼ˆæ•°æ®åº“ä¸­ç»´æŠ¤ï¼‰ â†’ æ¥æ„é€ è®¤è¯ä¿¡æ¯
    @Override
    protected AuthenticationInfo doGetAuthenticationInfo(AuthenticationToken authenticationToken) throws AuthenticationException {
        UsernamePasswordToken token = (UsernamePasswordToken) authenticationToken;
        String username = token.getUsername();

        //æ ¹æ®usernameæŸ¥è¯¢æ•°æ®åº“ä¸­å¯¹åº”password
        String password = selectPasswordByUsername(username);

        // principalä¿¡æ¯ â†’ å½“å‰æ”¾çš„æ˜¯ä»€ä¹ˆä¿¡æ¯ï¼Œåç»­å–å‡ºçš„å°±æ˜¯ä»€ä¹ˆä¿¡æ¯
        // å¯†ç    â†’ è¯¥å¯†ç ä¼šå’ŒTokenä¸­çš„passwordåšæ¯”è¾ƒ
        // realmåç§° â†’ æ²¡å•¥ç”¨
        return new SimpleAuthenticationInfo(username,password,getName());
    }

    @Override
    protected AuthorizationInfo doGetAuthorizationInfo(PrincipalCollection principalCollection) {
        // æ ¹æ®ç”¨æˆ·ä¿¡æ¯æ‹¿åˆ°æ‰€æœ‰çš„æƒé™ï¼ˆæ•°æ®åº“ï¼‰
        // doGetAuthenticationInfoæ–¹æ³•è¿”å›å€¼çš„ç¬¬ä¸€ä¸ªå‚æ•°å°±æ˜¯ç”¨æˆ·ä¿¡æ¯
        // åœ¨ç¬¬21è¡Œä»£ç æ”¾å…¥çš„æ˜¯å­—ç¬¦ä¸²ç±»å‹çš„Principalä¿¡æ¯ï¼Œå–å‡ºçš„æ—¶å€™å°±å¯ä»¥ä»¥å­—ç¬¦ä¸²æ ¼å¼å–å‡º
        String primaryPrincipal = (String) principalCollection.getPrimaryPrincipal();
        List<String> permissions = getPermissionsByUsername(primaryPrincipal);

        SimpleAuthorizationInfo simpleAuthorizationInfo = new SimpleAuthorizationInfo();
        simpleAuthorizationInfo.addStringPermissions(permissions);
        return simpleAuthorizationInfo;
    }

    private String selectPasswordByUsername(String username) {
        // åº”è¯¥é€šè¿‡MyBatisæ ¹æ®ç”¨æˆ·åæŸ¥è¯¢è·å¾—ç»“æœ

        return "123456";
    }

    private List<String> getPermissionsByUsername(String username) {
        // åº”è¯¥é€šè¿‡MyBatisæ ¹æ®ç”¨æˆ·åæŸ¥è¯¢è·å¾—ç»“æœ
        return Arrays.asList("admin:user:list", "admin:admin:list");
    }

}
```

### è®¤è¯

åœ¨å¯¹åº”è¯·æ±‚ä¸­è·å¾—subjectï¼Œå¹¶æ‰§è¡Œsubjectçš„loginæ–¹æ³•ã€‚

* å› ä¸ºç™»å½•è¯·æ±‚ä¸éœ€è¦æƒé™ï¼Œéœ€è¦å°†å…¶æƒé™è®¾ä¸ºanon
* subjectå¯¹è±¡å¯ä»¥åœ¨æ‰€æœ‰ç»„ä»¶ä¸­è·å¾—ï¼Œæ–¹å¼ä¸º`Subject subject = SecurityUtils.getSubject()`
* åœ¨ç»å¤§å¤šæ•°åœºæ™¯ä¸‹ï¼Œloginæ–¹æ³•çš„å‚æ•°éƒ½ä¸ºAuthenticationTokenæ¥å£ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨å…¶å®ç°ç±»UsernamePasswordTokenï¼š` subject.login(new UsernamePasswordToken(username,password))`
* å¦‚æœéœ€è¦è·å¾—sessionIdï¼Œå¯ä»¥ä½¿ç”¨subjectè·å¾—ï¼š` subject.getSession().getId()`

```java
@PostMapping("login")
public BaseRespVo<LoginUserData> login(@RequestBody Map map) {
    String username = (String)map.get("username");
    String password = (String)map.get("password");

    // æ•´åˆShiro
    // è·å¾—æ“ä½œçš„ä¸»ä½“
    Subject subject = SecurityUtils.getSubject();
    // loginæ–¹æ³•ä¼ å…¥çš„å‚æ•°AuthenticationToken â†’ è®¤è¯çš„ä»¤ç‰Œ
    // subjectæ‰§è¡Œlogin â†’ è®¤è¯å™¨æ‰§è¡Œè®¤è¯æ–¹æ³• â†’ realm.doGetAuthenticationInfo
    // AuthenticationToken â†’ UsernamePasswordToken â†’ ç›´æ¥å°è£…äº†usernameå’Œpassword
    // usernameå’Œpasswordé€šè¿‡Handleræ–¹æ³•çš„å½¢å‚ä¼ å…¥
    subject.login(new UsernamePasswordToken(username,password));

    if (subject.isAuthenticated()) {
        System.out.println("è®¤è¯æˆåŠŸ");
    }

    LoginUserData loginUserData = new LoginUserData();
    AdminInfoBean adminInfo = new AdminInfoBean();
    adminInfo.setAvatar("https://wpimg.wallstcn.com/f778738c-e4f8-4870-b634-56703b4acafe.gif");
    adminInfo.setNickName("admin123");
    loginUserData.setAdminInfo(adminInfo);
    // æºå¸¦SessionIdä¿¡æ¯
    loginUserData.setToken((String) subject.getSession().getId());
    return BaseRespVo.ok(loginUserData);
}
```

* è®¤è¯åå¯ä»¥é€šè¿‡`subject.getPrincipals().getPrimaryPrincipal()`æ¥è·å–ç”¨æˆ·åœ¨æ•°æ®åº“ä¸­çš„å…¶ä»–ä¿¡æ¯ã€‚è¯¥æ–¹æ³•çš„è¿”å›å€¼ä¸ºObjectï¼Œå¯ä»¥ç›´æ¥è½¬æ¢ä¸ºå¯¹åº”çš„ç”¨æˆ·ä¿¡æ¯POç±»ã€‚
* å¯ä»¥é€šè¿‡`subject.logout()`ç™»å‡ºç”¨æˆ·ã€‚

## HibernateValidation

åœ¨éœ€è¦å¯¹ä¸€äº›å‚æ•°è¿›è¡Œæ ¡éªŒæ—¶ï¼Œå¯ä»¥åœ¨Handleræ–¹æ³•çš„å½¢å‚ä¸Šå¢åŠ æ³¨è§£@Validæˆ–@Validatedï¼Œæˆ–åœ¨å¼•ç”¨ç±»å‹ä¸­çš„æˆå‘˜å˜é‡ä¸Šå¢åŠ æ ¡éªŒåŠŸèƒ½çš„æ³¨è§£ã€‚

å¸¸è§æ³¨è§£å¦‚ä¸‹ã€‚

```java
å¸¸è§çš„æ³¨è§£ ï¼ˆBean Validation ä¸­å†…ç½®çš„ constraintï¼‰     
@Null   è¢«æ³¨é‡Šçš„å…ƒç´ å¿…é¡»ä¸º null     
@NotNull    è¢«æ³¨é‡Šçš„å…ƒç´ å¿…é¡»ä¸ä¸º null     
@Size(max=, min=)   è¢«æ³¨é‡Šçš„å…ƒç´ çš„å¤§å°å¿…é¡»åœ¨æŒ‡å®šçš„èŒƒå›´å†…     
@AssertTrue     è¢«æ³¨é‡Šçš„å…ƒç´ å¿…é¡»ä¸º true     
@AssertFalse    è¢«æ³¨é‡Šçš„å…ƒç´ å¿…é¡»ä¸º false     
@Min(value)     è¢«æ³¨é‡Šçš„å…ƒç´ å¿…é¡»æ˜¯ä¸€ä¸ªæ•°å­—ï¼Œå…¶å€¼å¿…é¡»å¤§äºç­‰äºæŒ‡å®šçš„æœ€å°å€¼     
@Max(value)     è¢«æ³¨é‡Šçš„å…ƒç´ å¿…é¡»æ˜¯ä¸€ä¸ªæ•°å­—ï¼Œå…¶å€¼å¿…é¡»å°äºç­‰äºæŒ‡å®šçš„æœ€å¤§å€¼     
@DecimalMin(value)  è¢«æ³¨é‡Šçš„å…ƒç´ å¿…é¡»æ˜¯ä¸€ä¸ªæ•°å­—ï¼Œå…¶å€¼å¿…é¡»å¤§äºç­‰äºæŒ‡å®šçš„æœ€å°å€¼     
@DecimalMax(value)  è¢«æ³¨é‡Šçš„å…ƒç´ å¿…é¡»æ˜¯ä¸€ä¸ªæ•°å­—ï¼Œå…¶å€¼å¿…é¡»å°äºç­‰äºæŒ‡å®šçš„æœ€å¤§å€¼     
@Digits (integer, fraction)     è¢«æ³¨é‡Šçš„å…ƒç´ å¿…é¡»æ˜¯ä¸€ä¸ªæ•°å­—ï¼Œå…¶å€¼å¿…é¡»åœ¨å¯æ¥å—çš„èŒƒå›´å†…     
@Past   è¢«æ³¨é‡Šçš„å…ƒç´ å¿…é¡»æ˜¯ä¸€ä¸ªè¿‡å»çš„æ—¥æœŸ Date    
@Future     è¢«æ³¨é‡Šçš„å…ƒç´ å¿…é¡»æ˜¯ä¸€ä¸ªå°†æ¥çš„æ—¥æœŸ     
@Pattern(regex=,flag=)  è¢«æ³¨é‡Šçš„å…ƒç´ å¿…é¡»ç¬¦åˆæŒ‡å®šçš„æ­£åˆ™è¡¨è¾¾å¼     
Hibernate Validator é™„åŠ çš„ constraint     
@NotBlank(message =)   éªŒè¯å­—ç¬¦ä¸²énullï¼Œä¸”é•¿åº¦å¿…é¡»å¤§äº0     
@Email  è¢«æ³¨é‡Šçš„å…ƒç´ å¿…é¡»æ˜¯ç”µå­é‚®ç®±åœ°å€     
@Length(min=,max=)  è¢«æ³¨é‡Šçš„å­—ç¬¦ä¸²çš„å¤§å°å¿…é¡»åœ¨æŒ‡å®šçš„èŒƒå›´å†…     
@NotEmpty   è¢«æ³¨é‡Šçš„å­—ç¬¦ä¸²çš„å¿…é¡»éç©º     
@Range(min=,max=,message=)  è¢«æ³¨é‡Šçš„å…ƒç´ å¿…é¡»åœ¨åˆé€‚çš„èŒƒå›´å†…
```

